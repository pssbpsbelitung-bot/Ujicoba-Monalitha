<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Monitoring Harga (Basis Bulan)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;margin:0;padding:24px}
h1{margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;margin-bottom:24px}
.card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
select,button{padding:8px;border-radius:8px;border:1px solid #ccc;width:100%}
button{background:#374151;color:#fff;border:none}
.extreme{background:#fee2e2;color:#991b1b;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:bold}
canvas{width:100%!important;height:300px!important}
small{color:#6b7280}
</style>
</head>

<body>

<h1>ðŸ“Š Dashboard Monitoring & Evaluasi Harga</h1>

<!-- PILIH BULAN -->
<div class="grid">
  <div class="card">
    <h3>Pilih Bulan</h3>
    <select id="monthSelect"></select>
  </div>
</div>

<!-- FENOMENA (FREEZE BY BULAN) -->
<div class="grid">
  <div class="card">
    <h3>5 Fenomena Perubahan Harga Tertinggi (Bulanan)</h3>
    <ul id="fenomenaList"></ul>
  </div>
</div>

<!-- PILIH KOMODITAS -->
<div class="grid">
  <div class="card">
    <h3>Pilih Komoditas (Detail Grafik)</h3>
    <select id="commoditySelect"></select>
  </div>
</div>

<!-- GRAFIK -->
<div class="grid">
  <div class="card">
    <h3>Pergerakan Harga Komoditas</h3>
    <canvas id="priceChart"></canvas>
  </div>
</div>

<script>
const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQQ4j39acDNiz8Vx86BiJ0ePelFZco736J6qzZGU-xhckrFO8CBfjweBT_K8xV63ERrcqP0Rm1ESeKR/pub?output=csv";

let allData=[],fenomenaBulanan=[],priceChart;

/* CSV parser aman */
function parseCSV(text){
  const rows=[]; let cur=[],val='',inside=false;
  for(let c of text){
    if(c === '"') inside=!inside;
    else if(c === ',' && !inside){ cur.push(val); val=''; }
    else if(c === '\n' && !inside){ cur.push(val); rows.push(cur); cur=[]; val=''; }
    else val+=c;
  }
  cur.push(val); rows.push(cur);
  return rows;
}

async function loadData(){
  const res=await fetch(CSV_URL);
  const text=await res.text();
  const rows=parseCSV(text).slice(1);

  allData=rows.map(c=>({
    bulan:c[2],
    kegiatan:c[1],
    komoditas:c[5],
    harga:+c[7],
    selisih:+c[8],
    alasan:c[9]||'-'
  })).filter(d=>d.bulan && d.komoditas);

  init();
}

function init(){
  const bulan=[...new Set(allData.map(d=>d.bulan))];
  bulan.forEach(b=>monthSelect.add(new Option(b,b)));
  monthSelect.onchange=onMonthChange;
  commoditySelect.onchange=drawChart;
  onMonthChange();
}

/* =========================
   BULAN BERUBAH â†’ FENOMENA DIHITUNG SEKALI
   ========================= */
function onMonthChange(){
  const bulan=monthSelect.value;
  const dataBulan=allData.filter(d=>d.bulan===bulan);

  // Hitung fenomena BULANAN
  const map={};
  dataBulan.forEach(d=>{
    const key=d.komoditas+'|'+d.kegiatan;
    map[key]=(map[key]||0)+Math.abs(d.selisih);
  });

  fenomenaBulanan=Object.entries(map)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,5);

  renderFenomena(dataBulan);

  // Update komoditas (untuk grafik)
  const komoditas=[...new Set(dataBulan.map(d=>d.komoditas))];
  commoditySelect.innerHTML='';
  komoditas.forEach(k=>commoditySelect.add(new Option(k,k)));

  drawChart();
}

/* =========================
   FENOMENA TIDAK TERPENGARUH KOMODITAS
   ========================= */
function renderFenomena(dataBulan){
  fenomenaList.innerHTML='';
  fenomenaBulanan.forEach(([key,val])=>{
    const [komoditas,kegiatan]=key.split('|');
    const rows=dataBulan.filter(d=>d.komoditas===komoditas && d.kegiatan===kegiatan);
    const alasan=rows.reduce((a,b)=>{a[b.alasan]=(a[b.alasan]||0)+1;return a;},{});
    const topAlasan=Object.entries(alasan).sort((a,b)=>b[1]-a[1])[0][0];

    const li=document.createElement('li');
    li.innerHTML=`
      <b>${komoditas}</b><br>
      <small>Jenis Kegiatan: <b>${kegiatan}</b></small><br>
      Fenomena: <b>${topAlasan}</b><br>
      Total Perubahan: <b>${val.toLocaleString('id-ID')}</b>
    `;
    fenomenaList.appendChild(li);
  });
}

/* =========================
   KOMODITAS BERUBAH â†’ GRAFIK SAJA
   ========================= */
function drawChart(){
  const bulan=monthSelect.value;
  const kom=commoditySelect.value;
  const data=allData.filter(d=>d.bulan===bulan && d.komoditas===kom);

  if(priceChart) priceChart.destroy();
  priceChart=new Chart(priceChartEl,{
    type:'bar',
    data:{
      labels:data.map(d=>d.kegiatan),
      datasets:[{data:data.map(d=>d.selisih)}]
    }
  });
}

const priceChartEl=document.getElementById('priceChart');
loadData();
</script>

</body>
</html>
