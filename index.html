<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Monitoring Harga – Mode Pimpinan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --primary:#1f2937;
  --danger:#991b1b;
  --soft:#f3f4f6;
}
*{box-sizing:border-box}
body{
  font-family:Arial, sans-serif;
  background:#f9fafb;
  margin:0;
  padding:24px;
}
h1,h2,h3{margin:0 0 8px}
.container{
  display:grid;
  gap:20px;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
.header{
  background:#1f2937;
  color:white;
}
.grid-3{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}
.big-number{
  font-size:28px;
  font-weight:bold;
}
ul{padding-left:18px}
li{margin-bottom:16px}
.extreme{
  display:inline-block;
  margin-top:6px;
  background:#fee2e2;
  color:#991b1b;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:bold;
}
.hidden{display:none}
</style>
</head>

<body>
<div class="container">

  <!-- HEADER -->
  <div class="card header">
    <h1>Ringkasan Perkembangan Harga Komoditas</h1>
    <p>Mode Pimpinan – Monitoring Strategis</p>
  </div>

  <!-- IKHTISAR -->
  <div class="grid-3">
    <div class="card">
      <h3>Komoditas Paling Bergejolak</h3>
      <div class="big-number" id="topKomoditas">-</div>
    </div>
    <div class="card">
      <h3>Total Perubahan Harga</h3>
      <div class="big-number" id="totalPerubahan">-</div>
    </div>
    <div class="card">
      <h3>Fenomena Ekstrem</h3>
      <div class="big-number" id="jumlahEkstrem">-</div>
    </div>
  </div>

  <!-- FENOMENA UTAMA -->
  <div class="card">
    <h2>Fenomena Utama Perubahan Harga</h2>
    <ul id="fenomenaList"></ul>
  </div>

  <!-- NARASI -->
  <div class="card hidden" id="narasiPimpinan">
    <h2>Ringkasan Analisis</h2>
    <p id="narasiText"></p>
  </div>

</div>

<script>
// ================== KONFIGURASI ==================
const CSV_URL = "PASTE_LINK_CSV_GOOGLE_SHEETS_DI_SINI";

// ================== MODE ==================
const isPimpinan = new URLSearchParams(window.location.search).get('mode') === 'pimpinan';

// ================== LOAD DATA ==================
fetch(CSV_URL)
  .then(r=>r.text())
  .then(t=>{
    const rows = t.split('\n').slice(1);
    const d = rows.map(r=>{
      const c = r.split(',');
      return{
        kegiatan:c[1],
        bulan:c[2],
        petugas:c[4],
        komoditas:c[5],
        hargaLama:+c[6],
        hargaBaru:+c[7],
        selisih:+c[8],
        alasan:c[9] || 'Tidak ada keterangan'
      }
    }).filter(x=>x.komoditas);

    render(d);
  });

function render(d){
  const fenomena = {};
  d.forEach(x=>{
    const key = x.komoditas+'|'+x.kegiatan;
    fenomena[key]=(fenomena[key]||0)+Math.abs(x.selisih);
  });

  const nilai = Object.values(fenomena);
  const rata2 = nilai.reduce((a,b)=>a+b,0)/nilai.length;

  const list = document.getElementById('fenomenaList');
  const narasi = [];
  let ekstremCount = 0;

  const sorted = Object.entries(fenomena).sort((a,b)=>b[1]-a[1]);

  // IKHTISAR
  document.getElementById('topKomoditas').innerText = sorted[0][0].split('|')[0];
  document.getElementById('totalPerubahan').innerText =
    nilai.reduce((a,b)=>a+b,0).toLocaleString('id-ID');

  sorted.slice(0,5).forEach(([key,val])=>{
    const [komoditas,kegiatan] = key.split('|');
    const rows = d.filter(x=>x.komoditas===komoditas && x.kegiatan===kegiatan);

    // alasan terbanyak
    const ac = {};
    rows.forEach(r=>{
      ac[r.alasan]=(ac[r.alasan]||0)+1;
    });
    const alasanUtama = Object.entries(ac).sort((a,b)=>b[1]-a[1])[0][0];

    const isEkstrem = val > rata2*2;
    if(isEkstrem) ekstremCount++;

    const li = document.createElement('li');
    li.innerHTML = `
      <b>${komoditas}</b> (${kegiatan})<br>
      Fenomena: <b>${alasanUtama}</b><br>
      Total perubahan: <b>${val.toLocaleString('id-ID')}</b>
      ${isEkstrem?'<div class="extreme">Fenomena Ekstrem</div>':''}
    `;
    list.appendChild(li);

    narasi.push(
      `Komoditas ${komoditas} pada kegiatan ${kegiatan} mengalami perubahan harga yang didominasi oleh faktor ${alasanUtama.toLowerCase()}, dengan total perubahan sebesar ${val.toLocaleString('id-ID')}.`
    );
  });

  document.getElementById('jumlahEkstrem').innerText = ekstremCount;

  // NARASI
  if(isPimpinan){
    document.getElementById('narasiPimpinan').classList.remove('hidden');
    document.getElementById('narasiText').innerText =
      narasi.join(' ') + (ekstremCount
        ? ' Fenomena ekstrem memerlukan perhatian dan tindak lanjut lebih lanjut.'
        : '');
  }
}
</script>
</body>
</html>
