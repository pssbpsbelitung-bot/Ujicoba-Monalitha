<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Monitoring Harga</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bps-blue:#0057a8;
  --bps-blue-soft:#e9f2fb;
  --bps-gray:#f4f6f8;
  --text-dark:#1f2937;
  --text-muted:#6b7280;
}

*{box-sizing:border-box}
body{
  margin:0;
  padding:24px;
  font-family:'Inter',system-ui,sans-serif;
  background:var(--bps-gray);
  color:var(--text-dark);
}

h1{
  font-size:22px;
  margin-bottom:20px;
  color:var(--bps-blue);
}

.dashboard{
  display:grid;
  grid-template-columns:300px 1fr;
  gap:24px;
}

.card{
  background:#fff;
  border-radius:14px;
  padding:16px 18px;
  box-shadow:0 6px 18px rgba(0,0,0,.06);
}

.card h3{
  font-size:14px;
  font-weight:600;
  margin-bottom:12px;
  color:var(--bps-blue);
}

select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:14px;
}

.sidebar{
  display:flex;
  flex-direction:column;
  gap:16px;
}

.main{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
}

.kpi{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.kpi .value{
  font-size:26px;
  font-weight:700;
  color:var(--bps-blue);
}

.kpi .label{
  font-size:12px;
  color:var(--text-muted);
}

.full{
  grid-column:1/-1;
}

ul{
  padding-left:18px;
  margin:0;
}
li{
  margin-bottom:8px;
  font-size:14px;
}

canvas{
  height:320px!important;
}
</style>
</head>

<body>

<h1>Dashboard Monitoring Harga</h1>

<div class="dashboard">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="card">
      <h3>Pilih Bulan</h3>
      <select id="monthSelect"></select>
    </div>

    <div class="card">
      <h3>Pilih Komoditas</h3>
      <select id="commoditySelect"></select>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="card kpi">
      <div class="value" id="kpiKomoditas">0</div>
      <div class="label">Jumlah Komoditas</div>
    </div>

    <div class="card kpi">
      <div class="value" id="kpiFenomena">0</div>
      <div class="label">Fenomena Harga</div>
    </div>

    <div class="card kpi">
      <div class="value" id="kpiRata">0</div>
      <div class="label">Rata-rata Perubahan</div>
    </div>

    <div class="card full">
      <h3>5 Fenomena Perubahan Harga Tertinggi</h3>
      <ul id="fenomenaList"></ul>
    </div>

    <div class="card full">
      <h3>Pergerakan Harga (Bulan-1 vs Bulan Terpilih)</h3>
      <canvas id="priceChart"></canvas>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQQ4j39acDNiz8Vx86BiJ0ePelFZco736J6qzZGU-xhckrFO8CBfjweBT_K8xV63ERrcqP0Rm1ESeKR/pub?output=csv";

let data=[],chart,months=[];

function parseCSV(t){
  const r=[],c=[];let v='',q=false;
  for(const x of t){
    if(x=='"')q=!q;
    else if(x==','&&!q){c.push(v);v='';}
    else if(x=='\n'&&!q){c.push(v);r.push(c.splice(0));v='';}
    else v+=x;
  }
  c.push(v);r.push(c);
  return r;
}

fetch(CSV_URL).then(r=>r.text()).then(t=>{
  const rows=parseCSV(t).slice(1);
  data=rows.map(c=>({
    bulan:c[2],
    kegiatan:c[1],
    komoditas:c[5],
    selisih:+c[8]
  })).filter(d=>d.bulan&&d.komoditas);

  months=[...new Set(data.map(d=>d.bulan))].sort();
  init();
});

function init(){
  const ms=document.getElementById('monthSelect');
  months.forEach(m=>ms.add(new Option(m,m)));
  ms.onchange=onMonthChange;
  onMonthChange();
}

function onMonthChange(){
  const bulan=monthSelect.value;
  const bulanData=data.filter(d=>d.bulan===bulan);

  const komoditas=[...new Set(bulanData.map(d=>d.komoditas))];
  commoditySelect.innerHTML='';
  komoditas.forEach(k=>commoditySelect.add(new Option(k,k)));
  commoditySelect.onchange=drawChart;

  // KPI
  document.getElementById('kpiKomoditas').innerText=komoditas.length;
  document.getElementById('kpiFenomena').innerText=bulanData.length;
  document.getElementById('kpiRata').innerText=
    (bulanData.reduce((a,b)=>a+Math.abs(b.selisih),0)/bulanData.length||0)
    .toFixed(0);

  // Fenomena
  const map={};
  bulanData.forEach(d=>{
    const k=d.komoditas+'|'+d.kegiatan;
    map[k]=(map[k]||0)+Math.abs(d.selisih);
  });

  const top=Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,5);
  fenomenaList.innerHTML='';
  top.forEach(([k,v])=>{
    const [kom,keg]=k.split('|');
    fenomenaList.innerHTML+=`<li><b>${kom}</b> â€“ ${keg} (${v.toLocaleString('id-ID')})</li>`;
  });

  drawChart();
}

function drawChart(){
  const bulan=monthSelect.value;
  const idx=months.indexOf(bulan);
  if(idx<=0) return;

  const prev=months[idx-1];
  const kom=commoditySelect.value;

  const dPrev=data.filter(d=>d.bulan===prev&&d.komoditas===kom);
  const dNow=data.filter(d=>d.bulan===bulan&&d.komoditas===kom);

  const labels=[...new Set([...dPrev,...dNow].map(d=>d.kegiatan))];

  if(chart)chart.destroy();
  chart=new Chart(priceChart,{
    type:'bar',
    data:{
      labels,
      datasets:[
        {label:prev,data:labels.map(l=>(dPrev.find(x=>x.kegiatan===l)||{}).selisih||0),
         backgroundColor:'#9ca3af'},
        {label:bulan,data:labels.map(l=>(dNow.find(x=>x.kegiatan===l)||{}).selisih||0),
         backgroundColor:'#0057a8'}
      ]
    },
    options:{
      responsive:true,
      plugins:{legend:{position:'bottom'}},
      borderRadius:6
    }
  });
}
});
</script>

</body>
</html>
