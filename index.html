<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Monitoring Harga Monalitha</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;margin:0;padding:24px}
h1{margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;margin-bottom:24px}
.card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
.kpi{font-size:28px;font-weight:bold}
.kpi-label{color:#6b7280;font-size:14px}
select,button{padding:8px;border-radius:8px;border:1px solid #ccc;width:100%}
button{cursor:pointer;background:#2563eb;color:#fff;border:none}
button.secondary{background:#374151}
canvas{width:100%!important;height:300px!important}
.hide{display:none}
.extreme{
  background:#fee2e2;
  color:#991b1b;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:bold;
  display:inline-block;
  margin-top:6px;
}
</style>
</head>

<body>

<h1>ðŸ“Š Dashboard Monitoring & Evaluasi Harga (Monalitha)</h1>
<button id="modeBtn" class="secondary">Aktifkan Mode Pimpinan</button>

<!-- KPI PIMPINAN -->
<div id="kpiRow" class="grid hide">
  <div class="card"><div class="kpi" id="kpiKomoditas">0</div><div class="kpi-label">Komoditas Dipantau</div></div>
  <div class="card"><div class="kpi" id="kpiEntri">0</div><div class="kpi-label">Total Entri Bulan Ini</div></div>
  <div class="card"><div class="kpi" id="kpiEkstrem">0</div><div class="kpi-label">Fenomena Ekstrem</div></div>
</div>

<!-- FILTER -->
<div id="filterRow" class="grid">
  <div class="card"><h3>Komoditas</h3><select id="commoditySelect"></select></div>
  <div class="card"><h3>Bulan</h3><select id="monthSelect"></select></div>
</div>

<!-- BARIS 1 -->
<div class="grid mode-teknis">
  <div class="card">
    <h3>Perubahan Harga per Komoditas</h3>
    <canvas id="priceChart"></canvas>
  </div>
</div>

<!-- BARIS 2 -->
<div class="grid">
  <div class="card">
    <h3>Fenomena Perubahan Harga</h3>
    <ul id="fenomenaList"></ul>
  </div>
</div>

<!-- BARIS 3 -->
<div class="grid mode-teknis">
  <div class="card">
    <h3>Pergerakan Harga Tahunan</h3>
    <canvas id="yearChart"></canvas>
  </div>
</div>

<!-- NARASI -->
<div id="narasi" class="card hide"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQ4j39acDNiz8Vx86BiJ0ePelFZco736J6qzZGU-xhckrFO8CBfjweBT_K8xV63ERrcqP0Rm1ESeKR/pub?output=csv";

let priceChart,yearChart,modePimpinan=false;
let allData=[];

async function loadData(){
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const rows = text.split("\n").slice(1);

  allData = rows.map(r=>{
    const c=r.split(',');
    return{
      bulan:c[2],
      kegiatan:c[1],
      komoditas:c[5],
      selisih:+c[8],
      hargaBaru:+c[7],
      alasan:c[9]||'Tidak ada keterangan'
    }
  }).filter(d=>d.komoditas);

  init();
}

function init(){
  const kom=[...new Set(allData.map(d=>d.komoditas))];
  const bln=[...new Set(allData.map(d=>d.bulan))];

  kom.forEach(x=>commoditySelect.add(new Option(x,x)));
  bln.forEach(x=>monthSelect.add(new Option(x,x)));

  commoditySelect.onchange=render;
  monthSelect.onchange=render;
  render();
}

function render(){
  const k=commoditySelect.value;
  const m=monthSelect.value;

  const d=allData.filter(x=>x.komoditas===k);
  const p=allData.filter(x=>x.bulan===m);

  // ===== FENOMENA =====
  const f={};
  d.forEach(x=>{
    const key=x.komoditas+'|'+x.kegiatan;
    f[key]=(f[key]||0)+Math.abs(x.selisih);
  });

  const avg=Object.values(f).reduce((a,b)=>a+b,0)/Object.values(f).length;
  fenomenaList.innerHTML='';
  let ekstrem=0;
  let narasi=[];

  Object.entries(f).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([key,val])=>{
    const rows=d.filter(x=>x.komoditas+'|'+x.kegiatan===key);

    const ac={};
    rows.forEach(r=>ac[r.alasan]=(ac[r.alasan]||0)+1);
    const alasan=Object.entries(ac).sort((a,b)=>b[1]-a[1])[0][0];

    const isEkstrem=val>avg*2;
    if(isEkstrem) ekstrem++;

    const li=document.createElement('li');
    li.innerHTML=`
      <b>${key.split('|')[0]}</b><br>
      Fenomena: <b>${alasan}</b><br>
      Total perubahan: <b>${val.toLocaleString('id-ID')}</b>
      ${isEkstrem?'<div class="extreme">Fenomena Ekstrem</div>':''}
    `;
    fenomenaList.appendChild(li);

    narasi.push(`Komoditas ${key.split('|')[0]} mengalami perubahan harga yang dipengaruhi oleh ${alasan.toLowerCase()} dengan total perubahan sebesar ${val.toLocaleString('id-ID')}.`);
  });

  if(modePimpinan){
    kpiKomoditas.innerText=new Set(allData.map(x=>x.komoditas)).size;
    kpiEntri.innerText=p.length;
    kpiEkstrem.innerText=ekstrem;
    narasi.innerHTML='<b>Ringkasan Analisis:</b><br>'+narasi.join(' ');
  }

  drawCharts(d);
}

function drawCharts(d){
  if(priceChart)priceChart.destroy();
  priceChart=new Chart(priceChartEl,{
    type:'bar',
    data:{labels:d.map(x=>x.bulan),datasets:[{data:d.map(x=>x.selisih)}]}
  });

  if(yearChart)yearChart.destroy();
  yearChart=new Chart(yearChartEl,{
    type:'line',
    data:{labels:d.map(x=>x.bulan),datasets:[{data:d.map(x=>x.hargaBaru)}]}
  });
}

modeBtn.onclick=()=>{
  modePimpinan=!modePimpinan;
  kpiRow.classList.toggle('hide');
  filterRow.classList.toggle('hide');
  narasi.classList.toggle('hide');
  document.querySelectorAll('.mode-teknis').forEach(e=>e.classList.toggle('hide'));
  modeBtn.innerText=modePimpinan?'Matikan Mode Pimpinan':'Aktifkan Mode Pimpinan';
};

const priceChartEl=document.getElementById('priceChart');
const yearChartEl=document.getElementById('yearChart');

loadData();
</script>

</body>
</html>
