<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Monitoring Harga</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:Arial, sans-serif;
  background:#f3f4f6;
  margin:0;
  padding:24px;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  margin-bottom:20px;
}
select{
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #ddd;
}
h2{margin-top:0}
.alasan{
  font-size:13px;
  color:#555;
  margin-top:4px;
}
</style>
</head>
<body>

<div class="card">
  <h2>Filter</h2>
  <select id="bulan"></select>
</div>

<div class="card">
  <h2>Grafik Perbandingan Harga</h2>
  <canvas id="chartHarga"></canvas>
</div>

<div class="card">
  <h2>Fenomena Harga</h2>
  <ul id="fenomena"></ul>
</div>

<script>
const CSV_URL =
'https://docs.google.com/spreadsheets/d/e/2PACX-1vQQ4j39acDNiz8Vx86BiJ0ePelFZco736J6qzZGU-xhckrFO8CBfjweBT_K8xV63ERrcqP0Rm1ESeKR/pub?output=csv';

let allData=[], chart;

function parseCSV(text){
  return text.trim().split('\n').map(r=>r.split(','));
}

function normalizeBulan(v){
  if(!v) return '';
  const m=v.toLowerCase();
  if(m.includes('jan')) return 'January';
  if(m.includes('feb')) return 'February';
  if(m.includes('mar')) return 'March';
  if(m.includes('apr')) return 'April';
  if(m.includes('mei')||m.includes('may')) return 'May';
  if(m.includes('jun')) return 'June';
  if(m.includes('jul')) return 'July';
  if(m.includes('agu')||m.includes('aug')) return 'August';
  if(m.includes('sep')) return 'September';
  if(m.includes('okt')||m.includes('oct')) return 'October';
  if(m.includes('nov')) return 'November';
  if(m.includes('des')||m.includes('dec')) return 'December';
  return v;
}

function parseNumber(v){
  if(!v) return NaN;
  return Number(v.replace(/\./g,'').replace(/,/g,'.'));
}

function getAlasan(kom){
  const k=kom.toLowerCase();
  if(k.includes('beras')) return 'Perubahan pasokan dan distribusi.';
  if(k.includes('cabai')||k.includes('cabe')) return 'Produksi dipengaruhi faktor cuaca.';
  if(k.includes('bawang')) return 'Pasokan dari sentra produksi menurun.';
  return 'Dipengaruhi dinamika pasar.';
}

fetch(CSV_URL)
.then(r=>r.text())
.then(text=>{
  const rows=parseCSV(text);
  const header=rows.shift();

  const idx={
    bulan:header.indexOf('Bulan'),
    komoditas:header.indexOf('Komoditas'),
    kegiatan:header.indexOf('Jenis Kegiatan'),
    hargaSebelumnya:header.indexOf('Harga Sebelumnya'),
    hargaSekarang:header.indexOf('Harga Sekarang')
  };

  allData=rows.map(r=>({
    bulan:normalizeBulan(r[idx.bulan]),
    komoditas:r[idx.komoditas],
    kegiatan:r[idx.kegiatan],
    hargaSebelumnya:parseNumber(r[idx.hargaSebelumnya]),
    hargaSekarang:parseNumber(r[idx.hargaSekarang])
  }))
  .filter(d=>
    d.bulan &&
    d.komoditas &&
    !isNaN(d.hargaSebelumnya) &&
    !isNaN(d.hargaSekarang)
  );

  initBulan();
});

function initBulan(){
  const select=document.getElementById('bulan');
  const bulan=[...new Set(allData.map(d=>d.bulan))];
  select.innerHTML=bulan.map(b=>`<option>${b}</option>`).join('');
  select.onchange=updateView;
  updateView();
}

function updateView(){
  const bulan=document.getElementById('bulan').value;
  const list=allData.filter(d=>d.bulan===bulan);
  updateChart(list);
  updateFenomena(list);
}

function updateChart(list){
  const ctx=document.getElementById('chartHarga');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'bar',
    data:{
      labels:list.map(d=>d.komoditas),
      datasets:[
        {
          label:'Harga Sebelumnya',
          data:list.map(d=>d.hargaSebelumnya)
        },
        {
          label:'Harga Sekarang',
          data:list.map(d=>d.hargaSekarang)
        }
      ]
    }
  });
}

function updateFenomena(list){
  const ul=document.getElementById('fenomena');
  ul.innerHTML='';
  list.forEach(d=>{
    ul.innerHTML+=`
      <li>
        <b>${d.komoditas}</b> â€“ ${d.kegiatan}
        <div class="alasan">Alasan: ${getAlasan(d.komoditas)}</div>
      </li>`;
  });
}
</script>

</body>
</html>
