<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Monitoring Harga (Basis Bulan)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;margin:0;padding:24px}
h1{margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;margin-bottom:24px}
.card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
.kpi{font-size:28px;font-weight:bold}
.kpi-label{color:#6b7280;font-size:14px}
select,button{padding:8px;border-radius:8px;border:1px solid #ccc;width:100%}
button{cursor:pointer;background:#2563eb;color:#fff;border:none}
button.secondary{background:#374151}
.hide{display:none}
.extreme{
  background:#fee2e2;
  color:#991b1b;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:bold;
  display:inline-block;
  margin-top:6px;
}
small{color:#6b7280}
canvas{width:100%!important;height:300px!important}
</style>
</head>

<body>

<h1>ðŸ“Š Dashboard Monitoring & Evaluasi Harga</h1>
<button id="modeBtn" class="secondary">Aktifkan Mode Pimpinan</button>

<!-- KPI -->
<div id="kpiRow" class="grid hide">
  <div class="card"><div class="kpi" id="kpiFenomena">0</div><div class="kpi-label">Fenomena Dianalisis</div></div>
  <div class="card"><div class="kpi" id="kpiEkstrem">0</div><div class="kpi-label">Fenomena Ekstrem</div></div>
</div>

<!-- FILTER BULAN -->
<div class="grid">
  <div class="card">
    <h3>Pilih Bulan</h3>
    <select id="monthSelect"></select>
  </div>
</div>

<!-- FENOMENA -->
<div class="grid">
  <div class="card">
    <h3>5 Fenomena Perubahan Harga Tertinggi</h3>
    <ul id="fenomenaList"></ul>
  </div>
</div>

<!-- FILTER KOMODITAS -->
<div class="grid">
  <div class="card">
    <h3>Filter Komoditas (Opsional)</h3>
    <select id="commoditySelect">
      <option value="ALL">Semua Komoditas</option>
    </select>
  </div>
</div>

<!-- GRAFIK -->
<div class="grid mode-teknis">
  <div class="card">
    <h3>Pergerakan Harga</h3>
    <canvas id="priceChart"></canvas>
  </div>
</div>

<!-- NARASI -->
<div id="narasi" class="card hide"></div>

<script>
const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQQ4j39acDNiz8Vx86BiJ0ePelFZco736J6qzZGU-xhckrFO8CBfjweBT_K8xV63ERrcqP0Rm1ESeKR/pub?output=csv";

let allData=[],priceChart,modePimpinan=false;

/* ==== CSV PARSER AMAN (FIX UTAMA) ==== */
function parseCSV(text){
  const rows=[];
  let cur=[],val='',inside=false;

  for(let c of text){
    if(c === '"') inside=!inside;
    else if(c === ',' && !inside){ cur.push(val); val=''; }
    else if(c === '\n' && !inside){ cur.push(val); rows.push(cur); cur=[]; val=''; }
    else val+=c;
  }
  cur.push(val);
  rows.push(cur);
  return rows;
}

async function loadData(){
  const res=await fetch(CSV_URL);
  const text=await res.text();
  const rows=parseCSV(text).slice(1);

  allData=rows.map(c=>({
    kegiatan:c[1],
    bulan:c[2],
    komoditas:c[5],
    harga:+c[7],
    selisih:+c[8],
    alasan:c[9]||'Tidak ada keterangan'
  })).filter(d=>d.bulan && d.komoditas);

  init();
}

function init(){
  monthSelect.innerHTML='';
  commoditySelect.innerHTML='<option value="ALL">Semua Komoditas</option>';

  [...new Set(allData.map(d=>d.bulan))].forEach(b=>{
    monthSelect.add(new Option(b,b));
  });

  [...new Set(allData.map(d=>d.komoditas))].forEach(k=>{
    commoditySelect.add(new Option(k,k));
  });

  monthSelect.onchange=render;
  commoditySelect.onchange=render;

  render();
}

function render(){
  const bulan=monthSelect.value;
  const kom=commoditySelect.value;

  let data=allData.filter(d=>d.bulan===bulan);
  if(kom!=='ALL') data=data.filter(d=>d.komoditas===kom);

  const map={};
  data.forEach(d=>{
    const key=d.komoditas+'|'+d.kegiatan;
    map[key]=(map[key]||0)+Math.abs(d.selisih);
  });

  const avg=Object.values(map).reduce((a,b)=>a+b,0)/Math.max(1,Object.values(map).length);
  fenomenaList.innerHTML='';
  let ekstrem=0,narasi=[];

  Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([key,val])=>{
    const [komoditas,kegiatan]=key.split('|');
    const rows=data.filter(d=>d.komoditas===komoditas && d.kegiatan===kegiatan);

    const alasan=rows.reduce((a,b)=>{a[b.alasan]=(a[b.alasan]||0)+1;return a;},{});
    const topAlasan=Object.entries(alasan).sort((a,b)=>b[1]-a[1])[0][0];

    const isEkstrem=val>avg*2;
    if(isEkstrem) ekstrem++;

    const li=document.createElement('li');
    li.innerHTML=`
      <b>${komoditas}</b><br>
      <small>Jenis Kegiatan: <b>${kegiatan}</b></small><br>
      Fenomena: <b>${topAlasan}</b><br>
      Total Perubahan: <b>${val.toLocaleString('id-ID')}</b>
      ${isEkstrem?'<div class="extreme">Fenomena Ekstrem</div>':''}
    `;
    fenomenaList.appendChild(li);

    narasi.push(`Pada bulan ${bulan}, komoditas ${komoditas} mengalami perubahan harga signifikan akibat ${topAlasan.toLowerCase()}.`);
  });

  if(modePimpinan){
    kpiFenomena.innerText=Object.keys(map).length;
    kpiEkstrem.innerText=ekstrem;
    narasiEl.innerHTML='<b>Ringkasan:</b><br>'+narasi.join(' ');
  }

  drawChart(data);
}

function drawChart(data){
  if(priceChart)priceChart.destroy();
  priceChart=new Chart(priceChartEl,{
    type:'bar',
    data:{
      labels:data.map(d=>d.komoditas),
      datasets:[{data:data.map(d=>d.selisih)}]
    }
  });
}

modeBtn.onclick=()=>{
  modePimpinan=!modePimpinan;
  kpiRow.classList.toggle('hide');
  narasiEl.classList.toggle('hide');
  document.querySelectorAll('.mode-teknis').forEach(e=>e.classList.toggle('hide'));
  modeBtn.innerText=modePimpinan?'Matikan Mode Pimpinan':'Aktifkan Mode Pimpinan';
};

const priceChartEl=document.getElementById('priceChart');
const narasiEl=document.getElementById('narasi');

loadData();
</script>

</body>
</html>
