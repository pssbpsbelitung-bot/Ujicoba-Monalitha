<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Monitoring Harga (Perbandingan Bulanan)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;margin:0;padding:24px}
h1{margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;margin-bottom:24px}
.card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
select{padding:8px;border-radius:8px;border:1px solid #ccc;width:100%}
canvas{width:100%!important;height:300px!important}
small{color:#6b7280}
</style>
</head>

<body>

<h1>ðŸ“Š Dashboard Monitoring & Evaluasi Harga</h1>

<div class="grid">
  <div class="card">
    <h3>Pilih Bulan</h3>
    <select id="monthSelect"></select>
  </div>
</div>

<div class="grid">
  <div class="card">
    <h3>5 Fenomena Perubahan Harga Tertinggi</h3>
    <ul id="fenomenaList"></ul>
  </div>
</div>

<div class="grid">
  <div class="card">
    <h3>Pilih Komoditas (Grafik)</h3>
    <select id="commoditySelect"></select>
  </div>
</div>

<div class="grid">
  <div class="card">
    <h3>Pergerakan Harga Komoditas (Bulan-1 vs Bulan Pilihan)</h3>
    <canvas id="priceChart"></canvas>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQQ4j39acDNiz8Vx86BiJ0ePelFZco736J6qzZGU-xhckrFO8CBfjweBT_K8xV63ERrcqP0Rm1ESeKR/pub?output=csv";

let allData=[],fenomenaBulanan=[],chart;

function parseCSV(text){
  const rows=[],cur=[]; let v='',q=false;
  for(const c of text){
    if(c === '"') q=!q;
    else if(c===','&&!q){cur.push(v);v='';}
    else if(c==='\n'&&!q){cur.push(v);rows.push(cur.splice(0));v='';}
    else v+=c;
  }
  cur.push(v); rows.push(cur);
  return rows;
}

async function load(){
  const r=await fetch(CSV_URL);
  const t=await r.text();
  const rows=parseCSV(t).slice(1);

  allData=rows.map(c=>({
    bulan:c[2],
    kegiatan:c[1],
    komoditas:c[5],
    selisih:+c[8],
    alasan:c[9]||'-'
  })).filter(d=>d.bulan&&d.komoditas);

  init();
}

function init(){
  const monthSelect=document.getElementById('monthSelect');
  const months=[...new Set(allData.map(d=>d.bulan))];

  months.forEach(m=>monthSelect.add(new Option(m,m)));
  monthSelect.onchange=onMonthChange;

  onMonthChange();
}

function onMonthChange(){
  const month=document.getElementById('monthSelect').value;
  const dataMonth=allData.filter(d=>d.bulan===month);

  // === FENOMENA BULANAN (FREEZE) ===
  const map={};
  dataMonth.forEach(d=>{
    const k=d.komoditas+'|'+d.kegiatan;
    map[k]=(map[k]||0)+Math.abs(d.selisih);
  });

  fenomenaBulanan=Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,5);
  renderFenomena(dataMonth);

  // === KOMODITAS UNTUK GRAFIK ===
  const cs=document.getElementById('commoditySelect');
  cs.innerHTML='';
  [...new Set(dataMonth.map(d=>d.komoditas))]
    .forEach(k=>cs.add(new Option(k,k)));
  cs.onchange=drawChart;

  drawChart();
}

function renderFenomena(data){
  const ul=document.getElementById('fenomenaList');
  ul.innerHTML='';
  fenomenaBulanan.forEach(([key,val])=>{
    const [kom,keg]=key.split('|');
    const rows=data.filter(d=>d.komoditas===kom&&d.kegiatan===keg);
    const alasan=rows.reduce((a,b)=>{a[b.alasan]=(a[b.alasan]||0)+1;return a;},{});
    const top=Object.entries(alasan).sort((a,b)=>b[1]-a[1])[0][0];

    ul.innerHTML+=`
      <li>
        <b>${kom}</b><br>
        <small>Jenis Kegiatan: <b>${keg}</b></small><br>
        Fenomena: <b>${top}</b><br>
        Total Perubahan: <b>${val.toLocaleString('id-ID')}</b>
      </li>`;
  });
}

function drawChart(){
  const month=document.getElementById('monthSelect').value;
  const idx=[...new Set(allData.map(d=>d.bulan))].indexOf(month);
  if(idx<=0) return;

  const prev=[...new Set(allData.map(d=>d.bulan))][idx-1];
  const kom=document.getElementById('commoditySelect').value;

  const d1=allData.filter(d=>d.bulan===prev&&d.komoditas===kom);
  const d2=allData.filter(d=>d.bulan===month&&d.komoditas===kom);

  const labels=[...new Set([...d1,...d2].map(d=>d.kegiatan))];

  if(chart) chart.destroy();
  chart=new Chart(document.getElementById('priceChart'),{
    type:'bar',
    data:{
      labels,
      datasets:[
        {label:prev,data:labels.map(l=>(d1.find(x=>x.kegiatan===l)||{}).selisih||0)},
        {label:month,data:labels.map(l=>(d2.find(x=>x.kegiatan===l)||{}).selisih||0)}
      ]
    }
  });
}

load();
});
</script>

</body>
</html>
